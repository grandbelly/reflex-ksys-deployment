import reflex as rx
import os
import logging
from pathlib import Path

# Load environment variables from .env file
def load_env():
    env_path = Path(__file__).parent.parent / '.env'
    print(f"Loading .env from: {env_path}")
    if env_path.exists():
        with open(env_path, encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    key = key.strip()
                    value = value.strip()
                    os.environ[key] = value
                    print(f"Loaded env var: {key}={'***' if 'password' in key.lower() or 'dsn' in key.lower() else value}")
    else:
        print(f".env file not found at {env_path}")
    
    # ì¤‘ìš”í•œ í™˜ê²½ë³€ìˆ˜ í™•ì¸
    ts_dsn = os.getenv('TS_DSN')
    if ts_dsn:
        print("TS_DSN is loaded successfully")
    else:
        print("TS_DSN is not set!")

load_env()

# Database initialization on app startup
import psycopg

def create_tech_indicators_if_missing():
    """Tech indicators removed - focusing on trend analysis"""
    return  # Tech indicators removed
    try:
        dsn = os.getenv('TS_DSN')
        if dsn:
            with psycopg.connect(dsn, autocommit=True) as conn:
                with conn.cursor() as cur:
                    # Check if tech indicators views exist
                    cur.execute("""
                        SELECT view_name FROM timescaledb_information.continuous_aggregates
                        WHERE view_name LIKE 'tech_ind_%'
                    """)
                    existing_views = [row[0] for row in cur.fetchall()]

                    required_views = ['tech_ind_1m_mv', 'tech_ind_10m_mv', 'tech_ind_1h_mv', 'tech_ind_1d_mv']
                    missing_views = [v for v in required_views if v not in existing_views]

                    if missing_views:
                        print(f"ğŸ”„ Creating missing technical indicator views: {missing_views}")

                        # Create technical indicator continuous aggregates
                        tech_indicator_sql = """
                        -- Drop existing views safely
                        DROP MATERIALIZED VIEW IF EXISTS tech_ind_1m_mv CASCADE;
                        DROP MATERIALIZED VIEW IF EXISTS tech_ind_10m_mv CASCADE;
                        DROP MATERIALIZED VIEW IF EXISTS tech_ind_1h_mv CASCADE;
                        DROP MATERIALIZED VIEW IF EXISTS tech_ind_1d_mv CASCADE;

                        -- 1ë¶„ ê¸°ìˆ ì§€í‘œ ì—°ì† ì§‘ê³„
                        CREATE MATERIALIZED VIEW tech_ind_1m_mv
                        WITH (timescaledb.continuous) AS
                        SELECT
                            time_bucket('1 minute', ts) AS bucket,
                            tag_name,
                            COUNT(*) AS n,
                            AVG(value) AS avg,
                            AVG(value) AS sma_10,
                            AVG(value) AS sma_60,
                            AVG(value) + (2 * STDDEV(value)) AS bb_top,
                            AVG(value) - (2 * STDDEV(value)) AS bb_bot,
                            0.0 AS slope_60
                        FROM influx_hist
                        GROUP BY bucket, tag_name
                        ORDER BY bucket DESC, tag_name;

                        -- 10ë¶„ ê¸°ìˆ ì§€í‘œ ì—°ì† ì§‘ê³„
                        CREATE MATERIALIZED VIEW tech_ind_10m_mv
                        WITH (timescaledb.continuous) AS
                        SELECT
                            time_bucket('10 minutes', ts) AS bucket,
                            tag_name,
                            COUNT(*) AS n,
                            AVG(value) AS avg,
                            AVG(value) AS sma_10,
                            AVG(value) AS sma_60,
                            AVG(value) + (2 * STDDEV(value)) AS bb_top,
                            AVG(value) - (2 * STDDEV(value)) AS bb_bot,
                            0.0 AS slope_60
                        FROM influx_hist
                        GROUP BY bucket, tag_name
                        ORDER BY bucket DESC, tag_name;

                        -- 1ì‹œê°„ ê¸°ìˆ ì§€í‘œ ì—°ì† ì§‘ê³„
                        CREATE MATERIALIZED VIEW tech_ind_1h_mv
                        WITH (timescaledb.continuous) AS
                        SELECT
                            time_bucket('1 hour', ts) AS bucket,
                            tag_name,
                            COUNT(*) AS n,
                            AVG(value) AS avg,
                            AVG(value) AS sma_10,
                            AVG(value) AS sma_60,
                            AVG(value) + (2 * STDDEV(value)) AS bb_top,
                            AVG(value) - (2 * STDDEV(value)) AS bb_bot,
                            0.0 AS slope_60
                        FROM influx_hist
                        GROUP BY bucket, tag_name
                        ORDER BY bucket DESC, tag_name;

                        -- 1ì¼ ê¸°ìˆ ì§€í‘œ ì—°ì† ì§‘ê³„
                        CREATE MATERIALIZED VIEW tech_ind_1d_mv
                        WITH (timescaledb.continuous) AS
                        SELECT
                            time_bucket('1 day', ts) AS bucket,
                            tag_name,
                            COUNT(*) AS n,
                            AVG(value) AS avg,
                            AVG(value) AS sma_10,
                            AVG(value) AS sma_60,
                            AVG(value) + (2 * STDDEV(value)) AS bb_top,
                            AVG(value) - (2 * STDDEV(value)) AS bb_bot,
                            0.0 AS slope_60
                        FROM influx_hist
                        GROUP BY bucket, tag_name
                        ORDER BY bucket DESC, tag_name;
                        """

                        try:
                            cur.execute(tech_indicator_sql)
                            print("âœ… Technical indicator continuous aggregates created successfully")
                        except Exception as e:
                            print(f"âŒ Failed to create technical indicators: {e}")
                    else:
                        print("âœ… All technical indicator views already exist")

    except Exception as e:
        print(f"âš ï¸ Failed to create technical indicators: {e}")

def refresh_materialized_views():
    """Refresh materialized views on startup and periodically"""
    try:
        dsn = os.getenv('TS_DSN')
        if dsn:
            with psycopg.connect(dsn) as conn:
                with conn.cursor() as cur:
                    print("Refreshing materialized views...")
                    
                    # Refresh all technical indicator views
                    views_to_refresh = [
                        "tech_ind_1m_mv",
                        "tech_ind_10m_mv",
                        "tech_ind_1h_mv",
                        "tech_ind_1d_mv"
                    ]
                    
                    for view in views_to_refresh:
                        try:
                            # Try TimescaleDB continuous aggregate refresh first
                            cur.execute(f"CALL refresh_continuous_aggregate('{view}', NULL, NULL)")
                            print(f"  âœ… Refreshed {view} (continuous aggregate)")
                        except Exception as ve:
                            # Fallback to regular materialized view refresh
                            try:
                                cur.execute(f"REFRESH MATERIALIZED VIEW CONCURRENTLY public.{view}")
                                print(f"  âœ… Refreshed {view} (materialized)")
                            except Exception as ve2:
                                try:
                                    cur.execute(f"REFRESH MATERIALIZED VIEW public.{view}")
                                    print(f"  âœ… Refreshed {view} (materialized, non-concurrent)")
                                except Exception as ve3:
                                    print(f"  âš ï¸ Failed to refresh {view}: {ve3}")
                    
                    conn.commit()
                    print("âœ… All materialized views refreshed successfully")
    except Exception as e:
        print(f"âš ï¸ Failed to refresh materialized views: {e}")

# Run database initialization on startup
try:
    # Tech indicators removed - focusing on trend analysis
    pass
except:
    pass  # Don't fail app startup if initialization fails

from .components.layout import shell, stat_card
from .components.kpi_tiles import unified_kpi_card
from .components.gauge import radial_gauge
# Demo import removed from UI (keep file for reference)
from .components.features_table import features_table
from .components.trend_enhanced import clean_area_chart, metric_card, time_range_pills, sensor_info_header
from .states.dashboard import DashboardState as D
from .pages.communication import communication_page

# Feature Flag based imports
VERSION_TYPE = os.getenv('VERSION_TYPE', 'PART')
ENABLE_AI_FEATURES = os.getenv('ENABLE_AI_FEATURES', 'false').lower() == 'true'

# Conditional imports for AI features (FULL version only)
if VERSION_TYPE == 'FULL' or ENABLE_AI_FEATURES:
    try:
        from .pages.ai_insights import ai_insights_page
    except ImportError:
        ai_insights_page = None
        print("âš ï¸ AI insights page not available in PART version")
else:
    ai_insights_page = None

# ë³´ì•ˆ ê¸°ëŠ¥ ì¶”ê°€ (ì¶©ëŒ í•´ê²°)
try:
    from .security import validate_startup_security, get_csp_headers
    # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ì‹œ ë³´ì•ˆ ê²€ì¦
    validate_startup_security()
except ImportError:
    # ë³´ì•ˆ ëª¨ë“ˆì´ ì—†ìœ¼ë©´ ê²½ê³ ë§Œ ì¶œë ¥
    logging.warning("âš ï¸ ë³´ì•ˆ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë³´ì•ˆ ê²€ì¦ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
except Exception as e:
    logging.error(f"ğŸš¨ ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨: {e}", exc_info=True)
    # ê°œë°œí™˜ê²½ì—ì„œëŠ” ê³„ì† ì§„í–‰, ìš´ì˜í™˜ê²½ì—ì„œëŠ” ì¤‘ë‹¨ ê³ ë ¤


# Gradient creation function from dashboard template
def _create_gradient(color: str, id: str) -> rx.Component:
    return (
        rx.el.svg.defs(
            rx.el.svg.linear_gradient(
                rx.el.svg.stop(
                    stop_color=color, offset="5%", stop_opacity=0.8
                ),
                rx.el.svg.stop(
                    stop_color=color, offset="95%", stop_opacity=0
                ),
                x1=0,
                x2=0,
                y1=0,
                y2=1,
                id=id,
            ),
        ),
    )




# Chart toggle buttons (like dashboard template)
# ìƒìœ„ í† ê¸€: Area/Composed ì „í™˜ (ëŒ€ì‹œë³´ë“œ í…œí”Œë¦¿ ìŠ¤íƒ€ì¼)
def main_chart_toggle_button() -> rx.Component:
    """ì°¨íŠ¸ ë·° ëª¨ë“œ í† ê¸€ - ì „í™˜ ëŒ€ìƒ ëª¨ë“œ ì•„ì´ì½˜ì„ í‘œì‹œ"""
    return rx.cond(
        D.chart_view_mode,
        # Area ëª¨ë“œì¼ ë•Œ â†’ Composed ëª¨ë“œë¡œ ì „í™˜ (layers ì•„ì´ì½˜ í‘œì‹œ)
        rx.icon_button(
            rx.icon("layers"),
            size="2",
            cursor="pointer",
            variant="surface",
            on_click=D.toggle_chart_view_mode,
        ),
        # Composed ëª¨ë“œì¼ ë•Œ â†’ Area ëª¨ë“œë¡œ ì „í™˜ (area-chart ì•„ì´ì½˜ í‘œì‹œ)
        rx.icon_button(
            rx.icon("area-chart"),
            size="2",
            cursor="pointer", 
            variant="surface",
            on_click=D.toggle_chart_view_mode,
        ),
    )


# ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í† ê¸€ ê·¸ë£¹ ì»´í¬ë„ŒíŠ¸
def create_toggle_group(items: list, value: rx.Var, on_change, multiple: bool = False) -> rx.Component:
    """í†µì¼ëœ í† ê¸€ ê·¸ë£¹ ì»´í¬ë„ŒíŠ¸"""
    control_items = [rx.segmented_control.item(item["label"], value=item["value"]) for item in items]
    
    control_props = {
        "value": value,
        "on_change": on_change,
        "size": "2",
    }
    
    if multiple:
        control_props["type"] = "multiple"
    
    return rx.flex(
        rx.segmented_control.root(*control_items, **control_props),
        gap="3", align="center",
    )


def create_checkbox_group(items: list, selected: rx.Var, on_change) -> rx.Component:
    """Checkbox group for multiple selection"""
    def make_checkbox(item: dict) -> rx.Component:
        return rx.checkbox(
            item["label"],
            checked=selected.contains(item["value"]),
            on_change=lambda checked: on_change(item["value"], checked),
            size="2",
            color_scheme="blue",
        )
    
    return rx.flex(
        *[make_checkbox(item) for item in items],
        gap="3",
        wrap="wrap",
        align="center",
    )


# Area ëª¨ë“œ - Trend ê·¸ë£¹ í† ê¸€ ë²„íŠ¼ë“¤ (Segmented Control)
def trend_toggle_group() -> rx.Component:
    trend_items = [
        {"label": "Avg", "value": "avg"},
        {"label": "Min", "value": "min"},
        {"label": "Max", "value": "max"},
        {"label": "First", "value": "first"},
        {"label": "Last", "value": "last"},
    ]
    return create_toggle_group(trend_items, D.trend_selected, D.set_trend_selected)




# Composed ëª¨ë“œ - Trend ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ (ë‹¤ì¤‘ ì„ íƒ)
def trend_composed_checkboxes() -> rx.Component:
    trend_items = [
        {"label": "Min", "value": "min"},
        {"label": "Max", "value": "max"},
        {"label": "First", "value": "first"},
        {"label": "Last", "value": "last"},
    ]
    return create_checkbox_group(trend_items, D.trend_composed_selected, D.toggle_trend_composed_item)




# ìƒˆë¡œìš´ ì»´í¬ì¦ˆë“œ ì°¨íŠ¸: ì„¸ê·¸ë¨¼íŠ¸ ì»¨íŠ¸ë¡¤ ì—°ë™
def trend_composed_chart_new() -> rx.Component:
    """Trend Composed Chart with unified style"""
    return rx.recharts.composed_chart(
        rx.recharts.cartesian_grid(stroke_dasharray="3 3", opacity=0.1),
        rx.recharts.legend(vertical_align="top", height=30),
        rx.recharts.graphing_tooltip(),
        # Base average as bars (always shown)
        rx.recharts.bar(
            data_key="avg",
            fill="#10b981",
            opacity=0.3,
            name="Average"
        ),
        # Trend indicators with dashed lines
        rx.cond(
            D.show_trend_min,
            rx.recharts.line(
                data_key="min", 
                stroke="#60a5fa", 
                stroke_width=2, 
                stroke_dasharray="5 5",
                dot=False, 
                type_="monotone", 
                name="Min"
            ),
            rx.fragment()
        ),
        rx.cond(
            D.show_trend_max,
            rx.recharts.line(
                data_key="max", 
                stroke="#f97316", 
                stroke_width=2, 
                stroke_dasharray="8 4",
                dot=False, 
                type_="monotone", 
                name="Max"
            ),
            rx.fragment()
        ),
        rx.cond(
            D.show_trend_first,
            rx.recharts.line(
                data_key="first", 
                stroke="#22d3ee", 
                stroke_width=2, 
                stroke_dasharray="10 5", 
                dot=False, 
                type_="monotone", 
                name="First"
            ),
            rx.fragment()
        ),
        rx.cond(
            D.show_trend_last,
            rx.recharts.line(
                data_key="last", 
                stroke="#a78bfa", 
                stroke_width=2, 
                stroke_dasharray="12 3",
                dot=False, 
                type_="monotone", 
                name="Last"
            ),
            rx.fragment()
        ),
        rx.recharts.x_axis(data_key="bucket_formatted", stroke="#64748b", tick_line=False, axis_line=False, tick={"fontSize": "10px", "angle": -45, "textAnchor": "end"}, height=80, interval="preserveStartEnd"),
        rx.recharts.y_axis(domain=["auto","auto"], allow_decimals=True, stroke="#64748b", tick={"fontSize": "12px"}),
        data=D.series_for_tag,
        margin={"top": 50, "right": 30, "left": 20, "bottom": 100},
        height=500,
    )








def index() -> rx.Component:
    """ë©”ì¸ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ - ì˜ˆì „ ìŠ¤íƒ€ì¼ë¡œ ë³µì›"""
    return rx.fragment(
        # í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ìë™ ë¡œë”©
        rx.script("console.log('í˜ì´ì§€ ë¡œë“œë¨, ë°ì´í„° ë¡œë”© ì‹œì‘')"),
        shell( 
            rx.vstack(
                
                # ë¡œë”©/ì—ëŸ¬ ìƒíƒœ í‘œì‹œ (ë””ë²„ê¹… ì •ë³´ í¬í•¨)
                rx.cond(
                    D.loading,
                    rx.center(
                        rx.vstack(
                            rx.spinner(size="3"),
                            rx.text("ë°ì´í„° ë¡œë”© ì¤‘...", class_name="text-gray-600"),
                            rx.text(f"ì‹¤ì‹œê°„ ëª¨ë“œ: {D.realtime_mode}", class_name="text-xs text-gray-400"),
                            rx.text(f"ë¡œë”© ìƒíƒœ: {D.loading}", class_name="text-xs text-gray-400"),
                            spacing="3",
                            align="center"
                        ),
                        height="400px"
                    ),
                    rx.cond(
                        D.error,
                        rx.center(
                            rx.vstack(
                                rx.icon("circle-alert", size=48, color="red"),
                                rx.text(f"ì—ëŸ¬: {D.error}", class_name="text-red-600"),
                                rx.button("ë‹¤ì‹œ ì‹œë„", on_click=D.reload, color_scheme="red"),
                                spacing="3",
                                align="center"
                            ),
                            height="400px"
                        ),
                        # ì„¼ì„œ ì¹´ë“œ ê·¸ë¦¬ë“œ (ì˜ˆì „ ìŠ¤íƒ€ì¼)
                        rx.cond(
                            D.kpi_rows,
                            rx.box(
                                rx.foreach(
                                    D.kpi_rows,
                                    lambda r: unified_kpi_card(
                                        r["tag_name"],
                                        r["value_s"],
                                        r["delta_pct"],
                                        r["delta_s"],
                                        r["status_level"],
                                        r["ts_s"],
                                        r["range_label"],
                                        chart_data=r.get("mini_chart_data", []),
                                        gauge_pct=r.get("gauge_pct", 0),
                                        comm_status=r.get("comm_status"),
                                        comm_text=r.get("comm_text"),
                                        realtime_mode=D.realtime_mode,
                                        realtime_data=r.get("realtime_chart_data", []),
                                        qc_min=r.get("qc_min"),
                                        qc_max=r.get("qc_max"),
                                        on_detail_click=lambda tag=r["tag_name"]: D.open_detail_modal(tag),
                                        unit=r.get("unit", ""),
                                    )
                                ),
                                display="grid",
                                grid_template_columns="repeat(auto-fit, minmax(300px, 1fr))",
                                gap="4",
                                padding="4",
                                width="100%"
                            ),
                            # ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° (ë””ë²„ê¹… ì •ë³´ í¬í•¨)
                            rx.center(
                                rx.vstack(
                                    rx.icon("database", size=48, color="gray"),
                                    rx.text("ì„¼ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤", class_name="text-gray-600"),
                                    rx.text("KPI rows: ë¡œë”© ì¤‘...", class_name="text-xs text-gray-400"),
                                    rx.text("Tags: ë¡œë”© ì¤‘...", class_name="text-xs text-gray-400"), 
                                    rx.text("Latest: ë¡œë”© ì¤‘...", class_name="text-xs text-gray-400"),
                                    rx.text(f"Error: {D.error}", class_name="text-xs text-red-400"),
                                    rx.button("ìƒˆë¡œê³ ì¹¨", on_click=D.reload, color_scheme="blue"),
                                    spacing="3",
                                    align="center"
                                ),
                                height="400px"
                            )
                        )
                    )
                ),
                
                spacing="0",
                width="100%"
            ),
            # ë©”ì¸ ëŒ€ì‹œë³´ë“œì—ì„œë§Œ ë°ì´í„° ë¡œë“œ ë° ì‹¤ì‹œê°„ ëª¨ë“œ ì‹œì‘
            on_mount=D.load
        )
    )


app = rx.App(theme=rx.theme(appearance="light"), stylesheets=["/styles.css"])
app.add_page(index, route="/")

# Trend page (moved controls + series chart + measurement table)
def trend_page() -> rx.Component:
    return shell(
        rx.vstack(
            
            # Controls - Enhanced design
            rx.card(
                rx.flex(
                    rx.flex(
                        rx.icon("tag", size=16, color="gray"),
                        rx.text("íƒœê·¸ ì„ íƒ", size="2", weight="medium", color="gray"),
                        spacing="2",
                        align="center"
                    ),
                    rx.el.select(
                        rx.foreach(D.tags, lambda t: rx.el.option(t, value=t)),
                        value=rx.cond(D.tag_name, D.tag_name, ""),
                        on_change=[D.set_tag_select, D.load],
                        class_name="bg-white text-gray-900 px-3 py-2 rounded-lg border-2 border-blue-200 w-56 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm",
                    ),
                    rx.flex(
                        rx.icon("clock", size=16, color="gray"),
                        rx.text("ì¡°íšŒê¸°ê°„", size="2", weight="medium", color="gray"),
                        spacing="2",
                        align="center"
                    ),
                    rx.el.select(
                        rx.el.option("5ë¶„", value="5 min"),
                        rx.el.option("1ì‹œê°„", value="60 min"),
                        rx.el.option("24ì‹œê°„", value="24 hour"),
                        rx.el.option("7ì¼", value="7 days"),
                        rx.el.option("30ì¼", value="30 days"),
                        rx.el.option("3ê°œì›”", value="3 months"),
                        rx.el.option("1ë…„", value="12 months"),
                        value=D.window,
                        on_change=[D.set_window, D.load],
                        class_name="bg-white text-gray-900 px-3 py-2 rounded-lg border-2 border-blue-200 w-32 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm",
                    ),
                    spacing="4",
                    align="center"
                ),
                class_name="mb-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 shadow-md"
            ),
            
            # Series chart - Full-width responsive card
            rx.card(
                rx.flex(
                    rx.heading(rx.cond(D.tag_name, D.tag_name, "Time Series"), size="4", weight="bold"),
                    rx.spacer(),
                    rx.flex(
                        # Area ëª¨ë“œì¼ ë•Œ: í† ê¸€ ë²„íŠ¼ ê·¸ë£¹
                        rx.cond(
                            D.chart_view_mode,
                            trend_toggle_group(),
                            rx.fragment(),
                        ),
                        # Composed ëª¨ë“œì¼ ë•Œ: ì²´í¬ë°•ìŠ¤ë§Œ í‘œì‹œ (ë ˆê±°ì‹œ í† ê¸€ ì œê±°)
                        rx.cond(
                            D.chart_view_mode,
                            rx.fragment(),
                            trend_composed_checkboxes(),
                        ),
                        main_chart_toggle_button(),
                        gap="4", align="center",
                    ),
                    align="center", 
                    class_name="mb-4",
                ),
                
                rx.cond(
                    D.series_for_tag,
                    rx.cond(
                        D.chart_view_mode,
                        # Area ëª¨ë“œ: ì„ íƒëœ ê³„ì—´ë§Œ gradient area ì°¨íŠ¸ë¡œ í‘œì‹œ
                        rx.cond(
                            D.trend_selected == "avg",
                            rx.recharts.area_chart(
                                _create_gradient("#10b981", "avgGradient"),
                                rx.recharts.cartesian_grid(stroke_dasharray="3 3"),
                                rx.recharts.area(
                                    data_key="avg",
                                    stroke="#10b981",
                                    fill="url(#avgGradient)",
                                    type_="monotone",
                                    name="Average"
                                ),
                                rx.recharts.x_axis(data_key="bucket_formatted"),
                                rx.recharts.y_axis(),
                                rx.recharts.tooltip(),
                                rx.recharts.legend(),
                                data=D.series_for_tag,
                                height=500,
                            ),
                            rx.cond(
                                D.trend_selected == "min",
                                rx.recharts.area_chart(
                                    _create_gradient("#60a5fa", "minGradient"),
                                    rx.recharts.cartesian_grid(stroke_dasharray="3 3"),
                                    rx.recharts.area(
                                        data_key="min",
                                        stroke="#60a5fa",
                                        fill="url(#minGradient)",
                                        type_="monotone",
                                        name="Minimum"
                                    ),
                                    rx.recharts.x_axis(data_key="bucket_formatted"),
                                    rx.recharts.y_axis(),
                                    rx.recharts.tooltip(),
                                    rx.recharts.legend(),
                                    data=D.series_for_tag,
                                    height=500,
                                ),
                                rx.cond(
                                    D.trend_selected == "max",
                                    rx.recharts.area_chart(
                                        _create_gradient("#f97316", "maxGradient"),
                                        rx.recharts.cartesian_grid(stroke_dasharray="3 3"),
                                        rx.recharts.area(
                                            data_key="max",
                                            stroke="#f97316",
                                            fill="url(#maxGradient)",
                                            type_="monotone",
                                            name="Maximum"
                                        ),
                                        rx.recharts.x_axis(data_key="bucket_formatted"),
                                        rx.recharts.y_axis(),
                                        rx.recharts.tooltip(),
                                        rx.recharts.legend(),
                                        data=D.series_for_tag,
                                        height=500,
                                    ),
                                    rx.cond(
                                        D.trend_selected == "first",
                                        rx.recharts.area_chart(
                                            _create_gradient("#22d3ee", "firstGradient"),
                                            rx.recharts.cartesian_grid(stroke_dasharray="3 3"),
                                            rx.recharts.area(
                                                data_key="first",
                                                stroke="#22d3ee",
                                                fill="url(#firstGradient)",
                                                type_="monotone",
                                                name="First"
                                            ),
                                            rx.recharts.x_axis(data_key="bucket_formatted"),
                                            rx.recharts.y_axis(),
                                            rx.recharts.tooltip(),
                                            rx.recharts.legend(),
                                            data=D.series_for_tag,
                                            height=500,
                                        ),
                                        # trend_selected == "last"
                                        rx.recharts.area_chart(
                                            _create_gradient("#a78bfa", "lastGradient"),
                                            rx.recharts.cartesian_grid(stroke_dasharray="3 3"),
                                            rx.recharts.area(
                                                data_key="last",
                                                stroke="#a78bfa",
                                                fill="url(#lastGradient)",
                                                type_="monotone",
                                                name="Last"
                                            ),
                                            rx.recharts.x_axis(data_key="bucket_formatted"),
                                            rx.recharts.y_axis(),
                                            rx.recharts.tooltip(),
                                            rx.recharts.legend(),
                                            data=D.series_for_tag,
                                            height=500,
                                        ),
                                    ),
                                ),
                            ),
                        ),
                        # Composed ëª¨ë“œ: ìƒˆë¡œìš´ ë°©ì‹ (ì„¸ê·¸ë¨¼íŠ¸ ì»¨íŠ¸ë¡¤ ì—°ë™ ì°¨íŠ¸)
                        trend_composed_chart_new(),
                    ),
                    rx.flex(
                        rx.icon("line-chart", size=48, color="gray"),
                        rx.text("No chart data available", size="3", color="gray"),
                        rx.text("Adjust filters and reload", size="2", color="gray"),
                        direction="column",
                        align="center",
                        gap="2",
                        class_name="py-16",
                    ),
                ),
                class_name="w-full min-h-[500px]",
            ),
            
            # Measurement table - Full-width responsive
            features_table(),
            
            spacing="4",
            width="100%",
            class_name="p-4"
        ),
        # íŠ¸ë Œë“œ í˜ì´ì§€ - ë°ì´í„° ë¡œë”© ì—†ìŒ (ë©”ì¸ì—ì„œ ê´€ë¦¬)
        active_route="/trend",
    )

app.add_page(trend_page, route="/trend")

# Tech page removed - focusing on trend analysis
# app.add_page(tech_page, route="/tech")
# Add AI page only if available (FULL version)
if ai_insights_page is not None:
    app.add_page(ai_insights_page, route="/ai")  # AI Chat interface
app.add_page(communication_page, route="/comm")

# Real-time monitoring page
